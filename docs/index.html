<!doctype html>
<html lang="ko" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>â­ My Library â­</title>
    <link rel="stylesheet" href="css/style.css?v=2.0.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="js/bridge.js"></script>
    <script src="js/api_client.js"></script>
    <script src="js/main.js"></script>
    <link rel="icon" href="data:,">
  </head>
  <body>
    <div class="app-container">
      <header>
        <div class="header-top">
          <h1 onclick="location.reload()">ğŸ“š My Library</h1>
          <div class="controls">
            <input
              type="text"
              id="search"
              class="search-box"
              placeholder="ğŸ” ì‘í’ˆ ê²€ìƒ‰..."
              onkeyup="filterData()"
            />
            <!-- í…Œë§ˆ í† ê¸€ ë²„íŠ¼ -->
            <button class="btn-theme" onclick="toggleTheme()" title="í…Œë§ˆ ë³€ê²½">
              <span class="theme-icon">ğŸŒ™</span>
            </button>
          </div>
        </div>

        <div class="tab-bar">
          <div class="tab-group">
            <button class="tab-btn active" onclick="switchTab('all')">ğŸ“š ALL</button>
            <button class="tab-btn" onclick="switchTab('Novel')">ğŸ“– NOVEL</button>
            <button class="tab-btn" onclick="switchTab('Webtoon')">ğŸ¨ WEBTOON</button>
            <button class="tab-btn" onclick="switchTab('Manga')">ğŸ“• COMIC</button>
          </div>
          <div class="tab-tools">
            <button class="tab-btn btn-settings" onclick="toggleSettings()" title="ì‚¬ì´íŠ¸ ì„¤ì •">âš™ï¸</button>
            <button class="tab-btn btn-refresh" id="refreshBtn" onclick="refreshDB(null, false, true)" title="ìƒˆë¡œê³ ì¹¨ (ìºì‹œ ì¬êµ¬ì¶•)">â†»</button>
          </div>
        </div>

        <div
          id="domainPanel"
          class="settings-panel"
          style="display: none;"
        >
          <div class="settings-section">
            <h3 class="settings-title">ğŸ”— ë°”ë¡œê°€ê¸° ë„ë©”ì¸ (ë²ˆí˜¸)</h3>
            <div class="config-grid-3">
              <div class="config-item">
                <label class="config-label">ë§ˆë‚˜í† ë¼</label>
                <input
                  type="text"
                  id="url_manatoki"
                  class="config-input"
                  placeholder="469"
                />
              </div>
              <div class="config-item">
                <label class="config-label">ë‰´í† ë¼</label>
                <input
                  type="text"
                  id="url_newtoki"
                  class="config-input"
                  placeholder="469"
                />
              </div>
              <div class="config-item">
                <label class="config-label">ë¶í† ë¼</label>
                <input
                  type="text"
                  id="url_booktoki"
                  class="config-input"
                  placeholder="469"
                />
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3 class="settings-title">â˜ï¸ ì„œë²„ ì—°ê²° ì„¤ì •</h3>
            <div class="config-group">
              <label class="config-label">Folder ID</label>
              <input
                type="text"
                id="setting_folderId"
                class="config-input"
                placeholder="Google Drive Folder ID"
              />
            </div>
            <div class="config-group">
              <label class="config-label">GAS Deployment ID</label>
              <input
                type="text"
                id="setting_deployId"
                class="config-input"
                placeholder="AKfycb..."
              />
            </div>
            <div class="config-group">
              <label class="config-label">API Key (ë³´ì•ˆ)</label>
              <input
                type="password"
                id="setting_apiKey"
                class="config-input"
                placeholder="API Key"
              />
              <small class="config-hint">UserScript ì‚¬ìš© ì‹œ ìë™ ì„¤ì •</small>
            </div>
          </div>

          <div class="settings-section">
            <h3 class="settings-title">ğŸ‘ï¸ ë·°ì–´ ê¸°ë³¸ ì„¤ì •</h3>
            <div class="config-check-group">
              <label class="checkbox-label">
                <input type="checkbox" id="pref_2page" />
                <span>2ìª½ ë³´ê¸°</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="pref_cover" />
                <span>í‘œì§€ ìš°ì„ </span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="pref_rtl" />
                <span>ì¼ë³¸ë§Œí™”(ìš°ì¢Œ)</span>
              </label>
            </div>
          </div>

          <div class="config-group" style="display: none;">
            <label class="config-label">ì†Œì„¤ ë·°ì–´ ì—”ì§„</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="view_engine" value="foliate" />
                <span>Foliate (ê¶Œì¥)</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="view_engine" value="legacy" checked />
                <span>Legacy (í…ìŠ¤íŠ¸)</span>
              </label>
            </div>
          </div>

          <div class="settings-footer">
            <button class="btn btn-save" onclick="saveActiveSettings()">
              ğŸ’¾ ì „ì²´ ì €ì¥
            </button>
          </div>
          <div id="viewerVersionDisplay" class="version-info">
            Version: Loading...
          </div>
        </div>
      </header>

      <main class="main-content">
        <div class="grid-container" id="grid"></div>
      </main>
    </div>

    <!-- 1. Config Modal (First Run) -->
    <div id="configModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">âš™ï¸ ì„œë²„ ì—°ê²° ì„¤ì •</div>
        </div>
        <div class="modal-body" style="text-align: center">
          <p class="modal-desc">
            Google Apps Script ë°°í¬ URLê³¼ í´ë” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br />
            (PCì—ì„œ Tampermonkey ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œ ìë™ ì„¤ì •ë©ë‹ˆë‹¤.)
          </p>
          <div class="config-group">
            <label class="config-label">GAS ì›¹ ì•± URL</label>
            <input
              type="text"
              id="configApiUrl"
              class="config-input"
              placeholder="https://script.google.com/macros/s/.../exec"
            />
          </div>
          <div class="config-group">
            <label class="config-label">ë£¨íŠ¸ í´ë” ID</label>
            <input
              type="text"
              id="configFolderId"
              class="config-input"
              placeholder="Google Drive Folder ID"
            />
          </div>
          <div class="config-group">
            <label class="config-label">API Key (ë³´ì•ˆ)</label>
            <input
              type="password"
              id="configApiKey"
              class="config-input"
              placeholder="API Key (ì„ íƒì‚¬í•­)"
            />
            <small class="config-hint">UserScript ì‚¬ìš© ì‹œ ìë™ìœ¼ë¡œ ì£¼ì…ë©ë‹ˆë‹¤.</small>
          </div>
          <button class="btn btn-save" onclick="saveManualConfig()">
            ì„¤ì • ì €ì¥
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Info Modal -->
    <div id="editModal" class="modal-overlay">
      <div class="modal edit-modal">
        <div class="modal-header">
          <div class="modal-title">âœï¸ ì‘í’ˆ ì •ë³´ í¸ì§‘</div>
          <button class="modal-close" onclick="closeEditModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <!-- ì»¤ë²„ ì´ë¯¸ì§€ -->
          <div class="edit-cover-section">
            <div class="edit-cover-preview">
              <img id="editCoverPreview" src="" alt="ì»¤ë²„">
              <div class="edit-cover-no-image" id="editCoverNoImage">No Image</div>
            </div>
            <div class="edit-cover-actions">
              <label class="btn btn-upload" for="editCoverFile">ğŸ“· ì»¤ë²„ ì—…ë¡œë“œ</label>
              <input type="file" id="editCoverFile" accept="image/*" style="display:none" onchange="handleCoverSelect(event)">
              <div class="edit-cover-filename" id="editCoverFilename"></div>
            </div>
          </div>

          <!-- í¸ì§‘ í¼ -->
          <div class="edit-form">
            <div class="edit-field">
              <label>ì œëª©</label>
              <input type="text" id="editTitle" placeholder="ì‘í’ˆ ì œëª©">
            </div>
            <div class="edit-field">
              <label>ì‘ê°€</label>
              <input type="text" id="editAuthor" placeholder="ì‘ê°€ëª… (ì—¬ëŸ¬ëª…: ì‰¼í‘œ êµ¬ë¶„)">
            </div>
            <div class="edit-field">
              <label>ì—°ì¬ìƒíƒœ</label>
              <select id="editStatus">
                <option value="Unknown">ì•Œìˆ˜ì—†ìŒ</option>
                <option value="ì—°ì¬ì¤‘">ì—°ì¬ì¤‘</option>
                <option value="ì™„ê²°">ì™„ê²°</option>
                <option value="íœ´ì¬">íœ´ì¬</option>
              </select>
            </div>
            <div class="edit-field">
              <label>í”Œë«í¼</label>
              <select id="editPublisher">
                <option value="">ë¯¸ì§€ì •</option>
                <option value="ë„¤ì´ë²„">ë„¤ì´ë²„</option>
                <option value="ì¹´ì¹´ì˜¤">ì¹´ì¹´ì˜¤</option>
                <option value="ë¬¸í”¼ì•„">ë¬¸í”¼ì•„</option>
                <option value="ì¡°ì•„ë¼">ì¡°ì•„ë¼</option>
                <option value="ë¦¬ë””">ë¦¬ë””</option>
                <option value="ë…¸ë²¨í”¼ì•„">ë…¸ë²¨í”¼ì•„</option>
                <option value="ë ˆì§„ì½”ë¯¹ìŠ¤">ë ˆì§„ì½”ë¯¹ìŠ¤</option>
                <option value="íƒ‘íˆ°">íƒ‘íˆ°</option>
                <option value="ë´„íˆ°">ë´„íˆ°</option>
                <option value="ì¼ë³¸ë§Œí™”">ì¼ë³¸ë§Œí™”</option>
                <option value="ê¸°íƒ€í”Œë«í¼">ê¸°íƒ€í”Œë«í¼</option>
              </select>
            </div>
            <div class="edit-field">
              <label>ì¹´í…Œê³ ë¦¬</label>
              <select id="editCategory">
                <option value="Manga">ë§Œí™” (Manga)</option>
                <option value="Webtoon">ì›¹íˆ° (Webtoon)</option>
                <option value="Novel">ì†Œì„¤ (Novel)</option>
              </select>
            </div>
          </div>

          <!-- ìˆ¨ê¹€ í•„ë“œ (ë°ì´í„° ìœ ì§€ìš©) -->
          <input type="hidden" id="editSourceId">
          <input type="hidden" id="editUrl">

          <!-- ë²„íŠ¼ -->
          <div class="edit-buttons">
            <button class="btn edit-btn-cancel" onclick="closeEditModal()">ì·¨ì†Œ</button>
            <button class="btn edit-btn-save" onclick="saveEditInfo()">ğŸ’¾ ì €ì¥</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Episode Modal -->
    <div id="episodeModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">ğŸ“„ íšŒì°¨ ëª©ë¡</div>
          <button class="modal-close" onclick="closeEpisodeModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <div id="episodeList" class="episode-list"></div>
        </div>
      </div>
    </div>

    <!-- 3. Viewer Overlay -->
    <div id="viewerOverlay" class="viewer-overlay">
      <div
        class="viewer-content"
        id="viewerContent"
        onclick="handleViewerClick(event)"
      >
        <div class="nav-zone nav-prev"></div>
        <div class="nav-zone nav-next"></div>
        <div id="viewerImageContainer" class="viewer-image-container"></div>
        <div
          id="viewerScrollContainer"
          class="viewer-scroll-container"
          style="display: none"
        ></div>
        <div id="pageCounter" class="page-counter">- / -</div>
      </div>

      <div id="viewerControls" class="viewer-controls">
        <div class="viewer-header">
          <span class="viewer-title" id="viewerTitle">TokiViewer</span>
          <button class="btn-icon close-btn" onclick="closeViewer()">Ã—</button>
        </div>

        <div class="viewer-footer">
          <div class="footer-row main-row">
            <button
              class="btn-icon"
              onclick="openEpisodeListFromViewer()"
              title="ëª©ì°¨"
            >
              ğŸ“‘
            </button>

            <div class="slider-container">
              <span id="sliderCurrent" class="slider-label">1</span>
              <input
                type="range"
                id="pageSlider"
                min="1"
                max="100"
                value="1"
                step="1"
                oninput="onSliderInput(this.value)"
                onchange="onSliderChange(this.value)"
              />
              <span id="sliderTotal" class="slider-label">100</span>
            </div>

            <div class="nav-buttons">
              <button class="btn-icon" onclick="navigateViewer(-1)">â—€</button>
              <button class="btn-icon" onclick="navigateViewer(1)">â–¶</button>
            </div>
          </div>

          <div class="footer-row settings-row">
            <button
              id="btnTwoPage"
              class="btn-toggle image-only"
              onclick="toggleViewMode()"
            >
              2ìª½ ë³´ê¸°
            </button>
            <button
              id="btnCover"
              class="btn-toggle image-only"
              onclick="toggleCoverMode()"
            >
              í‘œì§€ ë¨¼ì €
            </button>
            <button
              id="btnScroll"
              class="btn-toggle"
              onclick="toggleScrollMode()"
            >
              ìŠ¤í¬ë¡¤ ë³´ê¸°
            </button>
            <button
              id="btnRtl"
              class="btn-toggle image-only"
              onclick="toggleRtlMode()"
            >
              ì¼ë³¸ì–´(ìš°ì¢Œ)
            </button>

            <button class="btn-toggle epub-only" onclick="changeFontSize(-2)">
              ê¸€ì -
            </button>
            <button class="btn-toggle epub-only" onclick="changeFontSize(2)">
              ê¸€ì +
            </button>

            <div class="divider"></div>
            <button
              id="btnPreload"
              class="btn-toggle"
              onclick="togglePreloadMode()"
            >
              ë¯¸ë¦¬ ë“±
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loader -->
    <div id="pageLoader" class="loader-overlay">
      <div class="spinner"></div>
      <div class="loader-text">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <!-- í…Œë§ˆ í† ê¸€ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      // í…Œë§ˆ ì´ˆê¸°í™”
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
      })();

      function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      }

      function updateThemeIcon(theme) {
        const icon = document.querySelector('.theme-icon');
        if (icon) {
          icon.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
        }
      }
    </script>

    <script type="module" src="js/include.js?v=3.3.4"></script>
  </body>
</html>
