<!doctype html>
<html lang="ko" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>⭐ My Library ⭐</title>
    <link rel="stylesheet" href="css/style.css?v=2.0.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="js/bridge.js"></script>
    <script src="js/api_client.js"></script>
    <script src="js/main.js"></script>
    <link rel="icon" href="data:,">
  </head>
  <body>
    <!-- 왼쪽 사이드바 토글 버튼 -->
    <button class="sidebar-toggle" onclick="toggleSidebar()" title="메뉴">
      <span class="toggle-icon">☰</span>
    </button>

    <!-- 왼쪽 슬라이드 사이드바 -->
    <div id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">메뉴</span>
        <button class="sidebar-close" onclick="toggleSidebar()">×</button>
      </div>

      <div class="sidebar-content">
        <!-- 상단 영역 (나중에 기능 추가용) -->
        <div class="sidebar-section">
          <div class="sidebar-placeholder">
            <span class="placeholder-icon">📌</span>
            <span class="placeholder-text">즐겨찾기</span>
          </div>
          <div class="sidebar-placeholder">
            <span class="placeholder-icon">📊</span>
            <span class="placeholder-text">통계</span>
          </div>
          <div class="sidebar-placeholder">
            <span class="placeholder-icon">🕐</span>
            <span class="placeholder-text">최근 본 작품</span>
          </div>
        </div>

        <div class="sidebar-divider"></div>

        <div class="sidebar-section">
          <div class="sidebar-placeholder">
            <span class="placeholder-icon">📁</span>
            <span class="placeholder-text">폴더 관리</span>
          </div>
          <div class="sidebar-placeholder">
            <span class="placeholder-icon">🏷️</span>
            <span class="placeholder-text">태그 관리</span>
          </div>
          <div class="sidebar-placeholder">
            <span class="placeholder-icon">💾</span>
            <span class="placeholder-text">백업/복원</span>
          </div>
        </div>

        <div class="sidebar-divider"></div>

        <!-- 설정 영역 -->
        <div class="sidebar-section settings-section">
          <h3 class="section-title">⚙️ 설정</h3>
          
          <div class="settings-group">
            <h4 class="group-title">🔗 바로가기 도메인</h4>
            <div class="input-row">
              <label>마나토끼</label>
              <input type="text" id="url_manatoki" class="config-input" placeholder="469" />
            </div>
            <div class="input-row">
              <label>뉴토끼</label>
              <input type="text" id="url_newtoki" class="config-input" placeholder="469" />
            </div>
            <div class="input-row">
              <label>북토끼</label>
              <input type="text" id="url_booktoki" class="config-input" placeholder="469" />
            </div>
          </div>

          <div class="settings-group">
            <h4 class="group-title">☁️ 서버 연결</h4>
            <div class="input-row">
              <label>Folder ID</label>
              <input type="text" id="setting_folderId" class="config-input" placeholder="Google Drive Folder ID" />
            </div>
            <div class="input-row">
              <label>GAS Deploy ID</label>
              <input type="text" id="setting_deployId" class="config-input" placeholder="AKfycb..." />
            </div>
            <div class="input-row">
              <label>API Key</label>
              <input type="password" id="setting_apiKey" class="config-input" placeholder="API Key" />
              <small class="input-hint">UserScript 사용 시 자동 설정</small>
            </div>
          </div>

          <div class="settings-group">
            <h4 class="group-title">👁️ 뷰어 설정</h4>
            <div class="checkbox-row">
              <label class="checkbox-label">
                <input type="checkbox" id="pref_2page" />
                <span>2쪽 보기</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="pref_cover" />
                <span>표지 우선</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="pref_rtl" />
                <span>일본만화(우좌)</span>
              </label>
            </div>
          </div>

          <button class="btn btn-save" onclick="saveActiveSettings()">
            💾 저장
          </button>

          <div id="viewerVersionDisplay" class="version-info">
            Version: Loading...
          </div>
        </div>
      </div>
    </div>

    <!-- 사이드바 오버레이 -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- 메인 앱 -->
    <div class="app-container">
      <header>
        <div class="header-top">
          <h1 onclick="location.reload()">📚 My Library</h1>
        </div>

        <div class="header-controls">
          <div class="search-wrapper">
            <span class="search-icon">🔍</span>
            <input
              type="text"
              id="search"
              class="search-box"
              placeholder="작품 검색..."
              onkeyup="filterData()"
            />
          </div>
          <button class="btn-theme" onclick="toggleTheme()" title="테마 변경">
            <span class="theme-icon">🌙</span>
          </button>
        </div>

        <nav class="tab-nav">
          <button class="tab-link active" onclick="switchTab('all')">All</button>
          <button class="tab-link" onclick="switchTab('Novel')">Novel</button>
          <button class="tab-link" onclick="switchTab('Webtoon')">Webtoon</button>
          <button class="tab-link" onclick="switchTab('Manga')">Comic</button>
        </nav>
      </header>

      <main class="main-content">
        <div class="grid-container" id="grid"></div>
      </main>
    </div>
        <!-- 1. Config Modal (First Run) -->
    <div id="configModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">⚙️ 서버 연결 설정</div>
        </div>
        <div class="modal-body" style="text-align: center">
          <p class="modal-desc">
            Google Apps Script 배포 URL과 폴더 ID를 입력하세요.<br />
            (PC에서 Tampermonkey 스크립트 실행 시 자동 설정됩니다.)
          </p>
          <div class="config-group">
            <label class="config-label">GAS 웹 앱 URL</label>
            <input
              type="text"
              id="configApiUrl"
              class="config-input"
              placeholder="https://script.google.com/macros/s/.../exec"
            />
          </div>
          <div class="config-group">
            <label class="config-label">루트 폴더 ID</label>
            <input
              type="text"
              id="configFolderId"
              class="config-input"
              placeholder="Google Drive Folder ID"
            />
          </div>
          <div class="config-group">
            <label class="config-label">API Key (보안)</label>
            <input
              type="password"
              id="configApiKey"
              class="config-input"
              placeholder="API Key (선택사항)"
            />
            <small class="input-hint">UserScript 사용 시 자동으로 주입됩니다.</small>
          </div>
          <button class="btn btn-save" onclick="saveManualConfig()">
            설정 저장
          </button>
        </div>
      </div>
    </div>

    <!-- Edit Info Modal -->
    <div id="editModal" class="modal-overlay">
      <div class="modal edit-modal">
        <div class="modal-header">
          <div class="modal-title">✏️ 작품 정보 편집</div>
          <button class="modal-close" onclick="closeEditModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="edit-cover-section">
            <div class="edit-cover-preview">
              <img id="editCoverPreview" src="" alt="커버">
              <div class="edit-cover-no-image" id="editCoverNoImage">No Image</div>
            </div>
            <div class="edit-cover-actions">
              <label class="btn btn-upload" for="editCoverFile">📷 커버 업로드</label>
              <input type="file" id="editCoverFile" accept="image/*" style="display:none" onchange="handleCoverSelect(event)">
              <div class="edit-cover-filename" id="editCoverFilename"></div>
            </div>
          </div>

          <div class="edit-form">
            <div class="edit-field">
              <label>제목</label>
              <input type="text" id="editTitle" placeholder="작품 제목">
            </div>
            <div class="edit-field">
              <label>작가</label>
              <input type="text" id="editAuthor" placeholder="작가명 (여러명: 쉼표 구분)">
            </div>
            <div class="edit-field">
              <label>연재상태</label>
              <select id="editStatus">
                <option value="Unknown">알수없음</option>
                <option value="연재중">연재중</option>
                <option value="완결">완결</option>
                <option value="휴재">휴재</option>
              </select>
            </div>
            <div class="edit-field">
              <label>플랫폼</label>
              <select id="editPublisher">
                <option value="">미지정</option>
                <option value="네이버">네이버</option>
                <option value="카카오">카카오</option>
                <option value="문피아">문피아</option>
                <option value="조아라">조아라</option>
                <option value="리디">리디</option>
                <option value="노벨피아">노벨피아</option>
                <option value="레진코믹스">레진코믹스</option>
                <option value="탑툰">탑툰</option>
                <option value="봄툰">봄툰</option>
                <option value="일본만화">일본만화</option>
                <option value="기타플랫폼">기타플랫폼</option>
              </select>
            </div>
            <div class="edit-field">
              <label>카테고리</label>
              <select id="editCategory">
                <option value="Manga">만화 (Manga)</option>
                <option value="Webtoon">웹툰 (Webtoon)</option>
                <option value="Novel">소설 (Novel)</option>
              </select>
            </div>
          </div>

          <input type="hidden" id="editSourceId">
          <input type="hidden" id="editUrl">

          <div class="edit-buttons">
            <button class="btn edit-btn-cancel" onclick="closeEditModal()">취소</button>
            <button class="btn edit-btn-save" onclick="saveEditInfo()">💾 저장</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. Episode Modal -->
    <div id="episodeModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">📄 회차 목록</div>
          <button class="modal-close" onclick="closeEpisodeModal()">×</button>
        </div>
        <div class="modal-body">
          <div id="episodeList" class="episode-list"></div>
        </div>
      </div>
    </div>

    <!-- 3. Viewer Overlay -->
    <div id="viewerOverlay" class="viewer-overlay">
      <div class="viewer-content" id="viewerContent" onclick="handleViewerClick(event)">
        <div class="nav-zone nav-prev"></div>
        <div class="nav-zone nav-next"></div>
        <div id="viewerImageContainer" class="viewer-image-container"></div>
        <div id="viewerScrollContainer" class="viewer-scroll-container" style="display: none"></div>
        <div id="pageCounter" class="page-counter">- / -</div>
      </div>

      <div id="viewerControls" class="viewer-controls">
        <div class="viewer-header">
          <span class="viewer-title" id="viewerTitle">TokiViewer</span>
          <button class="btn-icon close-btn" onclick="closeViewer()">×</button>
        </div>

        <div class="viewer-footer">
          <div class="footer-row main-row">
            <button class="btn-icon" onclick="openEpisodeListFromViewer()" title="목차">📑</button>

            <div class="slider-container">
              <span id="sliderCurrent" class="slider-label">1</span>
              <input
                type="range"
                id="pageSlider"
                min="1"
                max="100"
                value="1"
                step="1"
                oninput="onSliderInput(this.value)"
                onchange="onSliderChange(this.value)"
              />
              <span id="sliderTotal" class="slider-label">100</span>
            </div>

            <div class="nav-buttons">
              <button class="btn-icon" onclick="navigateViewer(-1)">◀</button>
              <button class="btn-icon" onclick="navigateViewer(1)">▶</button>
            </div>
          </div>

          <div class="footer-row settings-row">
            <button id="btnTwoPage" class="btn-toggle image-only" onclick="toggleViewMode()">2쪽 보기</button>
            <button id="btnCover" class="btn-toggle image-only" onclick="toggleCoverMode()">표지 먼저</button>
            <button id="btnScroll" class="btn-toggle" onclick="toggleScrollMode()">스크롤 보기</button>
            <button id="btnRtl" class="btn-toggle image-only" onclick="toggleRtlMode()">일본어(우좌)</button>
            <button class="btn-toggle epub-only" onclick="changeFontSize(-2)">글자 -</button>
            <button class="btn-toggle epub-only" onclick="changeFontSize(2)">글자 +</button>
            <div class="divider"></div>
            <button id="btnPreload" class="btn-toggle" onclick="togglePreloadMode()">미리 등</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loader -->
    <div id="pageLoader" class="loader-overlay">
      <div class="spinner"></div>
      <div class="loader-text">데이터 불러오는 중...</div>
    </div>

    <!-- Scripts -->
    <script>
      // 테마 초기화
      (function() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
      })();

      function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      }

      function updateThemeIcon(theme) {
        const icon = document.querySelector('.theme-icon');
        if (icon) {
          icon.textContent = theme === 'dark' ? '🌙' : '☀️';
        }
      }

      // 사이드바 토글
      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const toggleBtn = document.querySelector('.sidebar-toggle');
        
        sidebar.classList.toggle('open');
        overlay.classList.toggle('show');
        toggleBtn.classList.toggle('hidden');
      }

      // 탭 전환 시 active 클래스 관리
      const originalSwitchTab = window.switchTab;
      window.switchTab = function(tab) {
        document.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        if (originalSwitchTab) originalSwitchTab(tab);
      };
    </script>

    <script type="module" src="js/include.js?v=3.3.4"></script>
  </body>
</html>
